# Managing PDF attachments and OnPreRendering Report trigger for Electronic Invoicing
Business Central 2025 release wave 1 (version 26) introduced new capabilities for extracting attachments from PDF documents and a new report trigger `OnPreRendering`that will configure post processing of the PDF document generated by the report run. The `OnPreRendering` trigger will run after the last data item trigger and before `OnPostReport`.

The trigger scope is related to current REGF and E-invoicing requirements for embedded documents, additional files and protection

The `OnPreRendering`trigger allows the develop to:

- Append PDF documents to the output stream
- Attach one or more files to the PDF stream, where one of the files can be declared as the alternative invoice document (primary document) for electronic invoicong using the ZugFerd / Facturex standard (version 2.3) 
- Password protect the document using a user and admin passwords.

The sample code in this folder is selfcontained with respect to the new trigger capabilities, but have dependencies to the base application for blob, zip and download functionality. Notice that the support codeunits that are added here will be integrated in the base application and should not be used in production code.

The trigger will collect information needed for performing:

1) Document attachments for pdf targets
2) Append additional documents to the current output artifact
3) Protect the output artifact with user and admin passwords.

The data collected will be returned to the platform which will apply the necessary actions depending on the current scenarios (see also the internal processes in the diagram in section Runtime flow chart snippet):

- *Embed*: Will be applied when the report is saving an artifact (running SaveAsXX). Embedding documents does not apply to print / preview scenarios as the embedded files do not appear in the user facing pages. When the Json property primaryDocument has been set and the saveformat is specified as Einvoice, this attachment will be promoted to the Alternative representation of the master pdf document (invoice type) and will be added to the XMP pdf metadata for identification in electronic payment systems. The relationship type will be set according to the Json properties given when the attachment was defined (should be Alternative for the primary document and Data for other).
- *Append*: Will be applied to actions that show user facing versions of the artifact (print/preview) as the user can print to completed document like the end-user will set it.
- *Protect*: Will be applied to save and browser print scenarios. Documents that are scheduled for universal print will not be protected in the standard setup but will be protected if universal print fails and downloads to the web client print local print.

Notice that printing a protected document requires that the user enters the given user password. This is needed as you can print to a “Print to Pdf” printer that will store the document locally. The Current PdfPrint support in the WebClient does not support password protected documents and will not render the print page. This will be supported in a future update.

## Report action overview

| Intent/Action | Embed | Append | Protect |
|---|:---:|:---:|:---:|
| Save | X | X | X |
| Schedule | - | - | - |
| Preview | - | X | - |
| Print (universal) | - | X | - |
| Print (browser) | - | X | X |

## Trigger Scope

|Object type|Supported|
|:---|:---:|
|Report|X|
|Report Extension|X|

## AL Language extensions in the Reporting scope

### trigger OnPreRendering(var RenderingPayload: JsonObject);

The rendering schema is defined in section Report Rendering Payload Schema Definition on page 2.

OnPreRendering is a data collection trigger only, and will not invoke the processing instructions directly, but only build the Json object with a list of files to append or embed, and user/admin passwords. The platform will apply these values in the right context and ensure that files passed to the trigger are properly cleaned up afterwards.

### Rendering Payload Element definitions

The rendering payload is a json object providing instructions to the reporting runtime with respect to pdf postprocssing of the report output artifact.

The object must adhere to the following json schema:

| Json element | Documentation |
|---|---|
|version | Json schema version using the standard version format X.X.X.X |
| saveformat | Defines the final pdf file format to be one of the following values |
| | - Default (leave as is ) |
| | - PdfA3B – Convert to pure PDF/A-3B. |
| | - Einvoice – Convert to PDF/A-3B and add the xmp metadata for CrossIndustryDocument/invoice compliance. |
| primaryDocument | The name of the document represents the alternative version of the user facing pdf (this is the invoicing xml document). This document will be added to the xmp metadata as the DocumentFileName |
| attachments | List of attachments as a json array |
| attachments\name | Attachment name that will be stored in the pdf embedding. |
| attachments\description | Descriptive text for this attachment. |
| attachments\relationship | Relationship type according to the Adobe Pdf standard (use the enum type given in the sample extension). |
| attachments\mimetype | The attachment mimetype. The alternative invoice must be of type text\xml |
| attachments\filename | The filename that will point to the object to be attached (the server will delete the file when the operation is complete). |
| additionalDocuments | List of pdf files to append to the resulting document. |
| protection | Contains the optional document passwords. |
| protection\user | Defines the user password that is required to open the document. |
| protection\admin | Defines the admin password that gives full access to the document. Notice that if this element is empty, the platform will apply the user password to this field. |

Schema definition:

```json
{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "description": "",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "minLength": 1
    },
    "saveformat": {
      "type": "string",
      "enum": [ "Default", "PdfA3B", "Einvoice" ]
    },
    "primaryDocument": {
      "type": "string",
      "minLength": 1
    },
    "attachments": {
      "type": "array",
      "uniqueItems": true,
      "minItems": 0,
      "items": {
        "required": [
          "name",
          "description",
          "relationship",
          "mimetype",
          "filename"
        ],
        "properties": {
          "name": {
            "type": "string",
            "minLength": 1
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "relationship": {
            "type": "string",
            "enum": [ "Source", "Data", "Alternative", "Supplement", "Unspecified" ]
          },
          "mimetype": {
            "type": "string",
            "minLength": 1
          },
          "filename": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "additionalDocuments": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "protection": {
      "type": "object",
      "properties": {
        "user": {
          "type": "string",
          "minLength": 0
        },
        "admin": {
          "type": "string",
          "minLength": 0
        }
      },
      "required": [
        "user",
        "admin"
      ]
    }
  },
  "required": [
    "version",
    "saveformat",
    "attachments",
    "additionalDocuments",
    "protection"
  ]
}
```

### PdfSaveFormat Enum definition

```al
/// <summary>
/// Enum for the PDf formats that can be used.
/// Factur-X Version 1.07.2 (ZUGFeRD v. 2.3.2) | November 15th, 2024, section 6.2.2 Data relationship 
/// TODO: Replace standard reference with the Adope PDF v2.0 reference move this file to system app.
/// </summary>

enum 50951 PdfSaveFormat
{
    Extensible = false;

    /// <summary>
    /// Save the PDF in the default format (traditionally PDF version 1.7). Platform will decide the PDF version.
    /// </summary>
    value(0; Default)
    {
    }

    /// <summary>
    /// Save the PDF in the PDF/A-3B format. This will not update the embedded XMP metadata.
    /// </summary>
    value(1; PdfA3B)
    {
    }

    /// <summary>
    /// Save the PDF in the PDF/A-3B format and add the embedded XMP metadata requried by E-Invoice standards like ZUGFeRD/Facturec.
    /// </summary>
    value(2; Einvoice)
    {
    }
}
```

### Report Instance Properties

#### ReportTarget: ReportFormat

`ReportTarget` is a new report property using the existing `ReportFormat` built-in type defining output file formats (pdf, Word,…). This property will allow the AL developer to determine the current output format in any trigger following the request page (the last place the user can change).

## Sample usage

The sample extension contain a standalone test report and a report extension on the Standard Sales Invoice which illustrated potential use in the standard Invoice report.

The sample code configures the `ReportRenderingCompleteHandler` codeunit in the `OnPreReport` and `OnPreRendering` triggers, and support append, attach and protect. The files that are embedded and appended are created on the fly by helper code.

*Remember that the support codeunits and enumeration types will be added to BcApps, but included here for preview. Namespaces and function names will be updated in the released versions and the sample code cannot be garanteed to be equal to the future production code.*

### Limitations and known issues

#### Attachment file size

The maximum attachment file size is limited to 100  MB per attachment .

#### Pdf/A compliance

Conversion to PDF/A is not fully functional due to problems in the third-party component that is being used. The file is converted but fails compliance validation due to lack of font substitution and internal data structure. this will be fully supported in a coming update, but does not directly impact the attachment capability.

## Disclaimer

Microsoft Corporation (“Microsoft”) grants you a nonexclusive, perpetual, royalty-free right to use and modify the software code provided by us for the purposes of illustration  ("Sample Code") and to reproduce and distribute the object code form of the Sample Code, provided that you agree: (i) to not use our name, logo, or trademarks to market your software product in which the Sample Code is embedded; (ii) to include a valid copyright notice on your software product in which the Sample Code is embedded; and (iii) to indemnify, hold harmless, and defend us and our suppliers from and against any claims or lawsuits, whether in an action of contract, tort or otherwise, including attorneys’ fees, that arise or result from the use or distribution of the Sample Code or the use or other dealings in the Sample Code. Unless applicable law gives you more rights, Microsoft reserves all other rights not expressly granted herein, whether by implication, estoppel or otherwise.

THE SAMPLE CODE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL MICROSOFT OR ITS LICENSORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THE SAMPLE CODE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DA MAGE.
